name: Actualizar Datos Power BI

on:
  schedule:
    - cron: '0 6,12,18 * * *'  # 6 AM, 12 PM, 6 PM (Colombia UTC-5)
  workflow_dispatch:

jobs:
  actualizar-datos:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repositorio
        uses: actions/checkout@v3
      
      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Instalar dependencias
        run: |
          pip install -r requirements.txt
      
      - name: Crear credenciales de Google
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
        run: |
          mkdir -p config
          echo "$GOOGLE_CREDENTIALS" > config/credentials.json
      
      # ===================================================================
      # FASE 1: DESCARGA Y LIMPIEZA
      # ===================================================================
      - name: Descargar datos de Google Sheets
        run: python scripts/descargar_google_sheets.py
      
      - name: Limpiar y procesar datos
        run: python scripts/limpiar_datos.py
      
      - name: Validar UPZ y Zonas
        run: python scripts/validar_upz_zonas.py
      
      - name: Deduplicar actividades
        run: python scripts/deduplicar_actividades.py
      
      # ===================================================================
      # FASE 2: ENRIQUECIMIENTO CON BARRIOS
      # ===================================================================
      - name: Crear diccionario de barrios (si no existe)
        run: |
          if [ ! -f scripts/diccionario_barrios_completo.json ]; then
            python scripts/crear_diccionario_barrios.py
          fi
      
      - name: Enriquecer con barrios
        run: python scripts/enriquecer_con_barrios.py
      
      - name: Mejorar extracci√≥n de barrios
        run: python scripts/mejorar_extraccion_barrios.py
      
      # ===================================================================
      # FASE 3: GENERACI√ìN DE DIMENSIONES
      # ===================================================================
      - name: Generar dim_fecha
        run: python scripts/generar_dim_fecha.py
      
      - name: Generar dimensiones restantes
        run: python scripts/generar_dimensiones.py
      
      - name: Generar modelo dimensional completo
        run: python scripts/generar_modelo_completo.py
      
      # ===================================================================
      # FASE 4: VERIFICACI√ìN Y REPORTE
      # ===================================================================
      - name: Verificar integridad de datos
        run: python scripts/verificar_datos.py
      
      - name: Generar reporte de actualizaci√≥n
        run: |
          python scripts/generar_reporte.py > logs/reporte_$(date +'%Y%m%d_%H%M').txt
      
      # ===================================================================
      # FASE 5: COMMIT Y PUSH
      # ===================================================================
      - name: Commit y push de cambios
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/*.csv dimensiones/*.csv fact_actividades_*.csv
          git diff --quiet && git diff --staged --quiet || \
          (git commit -m "ü§ñ Actualizaci√≥n autom√°tica de datos - $(date +'%Y-%m-%d %H:%M')" && git push)
      
      - name: Subir logs como artefactos
        uses: actions/upload-artifact@v3
        with:
          name: logs-actualizacion
          path: logs/
          retention-days: 30
