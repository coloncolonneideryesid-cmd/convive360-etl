name: üìä ETL Pipeline Convive360

on:
  # Ejecutar cada hora
  schedule:
    - cron: '0 * * * *'
  
  # Permitir ejecuci√≥n manual
  workflow_dispatch:
  
  # Ejecutar cuando hay push a main
  push:
    branches:
      - main
    paths:
      - 'run_pipeline.py'
      - 'scripts/**'
      - '.github/workflows/**'

jobs:
  etl-process:
    name: Ejecutar ETL y Actualizar Datos
    runs-on: ubuntu-latest
    
    steps:
      # ========================================
      # 1. CHECKOUT DEL REPOSITORIO
      # ========================================
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      # ========================================
      # 2. CONFIGURAR PYTHON
      # ========================================
      - name: üêç Configurar Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      # ========================================
      # 3. INSTALAR DEPENDENCIAS
      # ========================================
      - name: üì¶ Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # ========================================
      # 4. CREAR ARCHIVO DE CREDENCIALES
      # ========================================
      - name: üîê Crear archivo de credenciales de Google
        run: |
          echo '${{ secrets.GOOGLE_CREDENTIALS }}' > credentials.json
          chmod 600 credentials.json
      
      # ========================================
      # 5. VERIFICAR CREDENCIALES
      # ========================================
      - name: ‚úÖ Verificar archivo de credenciales
        run: |
          if [ ! -f "credentials.json" ]; then
            echo "‚ùå Error: No se cre√≥ el archivo credentials.json"
            exit 1
          fi
          echo "‚úÖ Archivo credentials.json creado correctamente"
          
          # Verificar que sea un JSON v√°lido
          python -c "import json; json.load(open('credentials.json'))" || {
            echo "‚ùå Error: El archivo credentials.json no es un JSON v√°lido"
            exit 1
          }
          echo "‚úÖ JSON v√°lido confirmado"
      
      # ========================================
      # 6. EJECUTAR PIPELINE ETL
      # ========================================
      - name: üöÄ Ejecutar Pipeline ETL
        env:
          SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          SHEET_NAME_1: ${{ secrets.SHEET_NAME_1 }}
          SHEET_NAME_2: ${{ secrets.SHEET_NAME_2 }}
        run: |
          echo "=========================================="
          echo "üöÄ INICIANDO PIPELINE ETL CONVIVE360"
          echo "=========================================="
          echo "üìÖ Fecha: $(date +'%Y-%m-%d %H:%M:%S')"
          echo "üìä Spreadsheet ID: ${SPREADSHEET_ID}"
          echo "üìÑ Hoja 1: ${SHEET_NAME_1}"
          echo "üìÑ Hoja 2: ${SHEET_NAME_2}"
          echo "=========================================="
          echo ""
          
          python run_pipeline.py
          
          echo ""
          echo "=========================================="
          echo "‚úÖ PIPELINE COMPLETADO"
          echo "=========================================="
      
      # ========================================
      # 7. VERIFICAR ARCHIVOS GENERADOS
      # ========================================
      - name: üìã Verificar archivos generados
        run: |
          echo "Verificando archivos generados..."
          
          # Verificar tabla de hechos
          if [ ! -f "fact_actividades.csv" ]; then
            echo "‚ùå Error: No se gener√≥ fact_actividades.csv"
            exit 1
          fi
          echo "‚úÖ fact_actividades.csv generado"
          
          # Verificar tabla de hechos limpia
          if [ ! -f "fact_actividades_limpio.csv" ]; then
            echo "‚ùå Error: No se gener√≥ fact_actividades_limpio.csv"
            exit 1
          fi
          echo "‚úÖ fact_actividades_limpio.csv generado"
          
          # Verificar directorio de dimensiones
          if [ ! -d "dimensiones" ]; then
            echo "‚ùå Error: No se cre√≥ el directorio dimensiones"
            exit 1
          fi
          echo "‚úÖ Directorio dimensiones creado"
          
          # Listar archivos de dimensiones
          echo ""
          echo "Archivos de dimensiones generados:"
          ls -lh dimensiones/*.csv 2>/dev/null || echo "‚ö†Ô∏è No se encontraron archivos de dimensiones"
          
          # Mostrar tama√±os
          echo ""
          echo "Tama√±os de archivos:"
          du -h fact_actividades*.csv dimensiones/*.csv 2>/dev/null || true
      
      # ========================================
      # 8. CONFIGURAR GIT
      # ========================================
      - name: ‚öôÔ∏è Configurar Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"
      
      # ========================================
      # 9. COMMIT DE ARCHIVOS GENERADOS
      # ========================================
      - name: üíæ Commit archivos generados
        run: |
          # Agregar archivos generados
          git add -f fact_actividades.csv
          git add -f fact_actividades_limpio.csv
          git add -f dimensiones/*.csv
          git add -f pipeline_log.txt || true
          
          # Verificar si hay cambios
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è No hay cambios para commitear"
          else
            # Hacer commit
            FECHA=$(date +'%Y-%m-%d %H:%M')
            git commit -m "ü§ñ Actualizaci√≥n autom√°tica ETL - ${FECHA}"
            echo "‚úÖ Commit realizado: ${FECHA}"
          fi
      
      # ========================================
      # 10. PUSH DE CAMBIOS
      # ========================================
      - name: üöÄ Push cambios a GitHub
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
      
      # ========================================
      # 11. LIMPIAR CREDENCIALES
      # ========================================
      - name: üßπ Limpiar archivos sensibles
        if: always()
        run: |
          rm -f credentials.json
          echo "‚úÖ Archivo de credenciales eliminado"
      
      # ========================================
      # 12. RESUMEN FINAL
      # ========================================
      - name: üìù Resumen de ejecuci√≥n
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "üìä RESUMEN DE EJECUCI√ìN"
          echo "=========================================="
          echo "üìÖ Fecha: $(date +'%Y-%m-%d %H:%M:%S')"
          echo "üîÑ Workflow: ${{ github.workflow }}"
          echo "üåø Branch: ${{ github.ref }}"
          echo "üíª Commit: ${{ github.sha }}"
          echo "üë§ Actor: ${{ github.actor }}"
          echo "=========================================="
