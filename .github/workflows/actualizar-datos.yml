name: Actualizar Datos Power BI

on:
  schedule:
    - cron: '0 6,12,18 * * *'  # 6 AM, 12 PM, 6 PM (Colombia UTC-5)
  workflow_dispatch:

jobs:
  actualizar-datos:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repositorio
        uses: actions/checkout@v4
      
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Instalar dependencias
        run: |
          pip install -r requirements.txt
      
      - name: Crear credenciales de Google
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
        run: |
          mkdir -p config
          echo "$GOOGLE_CREDENTIALS" > config/credentials.json
      
      # ===================================================================
      - name: üì• Importar datos desde Google Sheets
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
        run: |
          echo "=== Importando datos desde Google Sheets ==="
          python scripts/importar_desde_sheets.py
      
      - name: üó∫Ô∏è Mapear columnas
        run: |
          echo "=== Mapeando columnas ==="
          python scripts/mapear_columnas.py
      
      - name: üßπ Limpiar datos con diccionario
        run: |
          echo "=== Limpiando datos ==="
          python scripts/limpiar_agendamiento_con_diccionario.py
      
      - name: üîÑ Deduplicar actividades
        run: |
          echo "=== Deduplicando actividades ==="
          python scripts/deduplicar_agendamiento.py
      
      # ===================================================================
      # FASE 2: ENRIQUECIMIENTO CON BARRIOS
      # ===================================================================
      - name: üìö Crear diccionario de barrios (si no existe)
        run: |
          if [ ! -f scripts/diccionario_barrios_completo.json ]; then
            echo "=== Creando diccionario de barrios ==="
            python scripts/crear_diccionario_barrios.py
          else
            echo "‚úÖ Diccionario ya existe, saltando creaci√≥n"
          fi
      
      - name: üìç Enriquecer con barrios
        run: |
          echo "=== Enriqueciendo datos con barrios ==="
          python scripts/enriquecer_con_barrios.py
      
      - name: üîß Mejorar extracci√≥n de barrios
        run: |
          echo "=== Mejorando extracci√≥n de barrios ==="
          python scripts/mejorar_extraccion_barrios.py
      
      # ===================================================================
      # FASE 3: GENERACI√ìN DE DIMENSIONES
      # ===================================================================
      - name: üìä Generar dimensiones b√°sicas
        run: |
          echo "=== Generando dimensiones b√°sicas ==="
          python scripts/generar_dimensiones.py
      
      - name: üéØ Generar modelo dimensional completo
        run: |
          echo "=== Generando modelo dimensional completo ==="
          python scripts/generar_modelo_completo.py
      
      # ===================================================================
      # FASE 4: VERIFICACI√ìN
      # ===================================================================
      - name: ‚úÖ Verificar archivos generados
        run: |
          echo ""
          echo "==================================================================="
          echo "üìä RESUMEN DE ARCHIVOS GENERADOS"
          echo "==================================================================="
          echo ""
          
          echo "üìÅ Dimensiones generadas:"
          if [ -d "dimensiones" ]; then
            ls -lh dimensiones/*.csv 2>/dev/null | awk '{print "   ‚úÖ", $9, "-", $5}' || echo "   ‚ö†Ô∏è  No se generaron archivos CSV"
          else
            echo "   ‚ùå Carpeta dimensiones/ no existe"
          fi
          
          echo ""
          echo "üìÑ Fact tables:"
          ls -lh fact_*.csv 2>/dev/null | awk '{print "   ‚úÖ", $9, "-", $5}' || echo "   ‚ö†Ô∏è  No se generaron fact tables"
          
          echo ""
          echo "üìà Estad√≠sticas:"
          if [ -f "fact_actividades_enriquecido.csv" ]; then
            TOTAL_ROWS=$(wc -l < fact_actividades_enriquecido.csv)
            echo "   ‚Ä¢ Total actividades: $((TOTAL_ROWS - 1))"
          fi
          
          if [ -f "dimensiones/dim_barrios.csv" ]; then
            TOTAL_BARRIOS=$(wc -l < dimensiones/dim_barrios.csv)
            echo "   ‚Ä¢ Total barrios: $((TOTAL_BARRIOS - 1))"
          fi
          
          echo ""
          echo "==================================================================="
      
      # ===================================================================
      # FASE 5: COMMIT Y PUSH
      # ===================================================================
      - name: üíæ Commit y push de cambios
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Agregar todos los archivos generados
          git add -A
          
          # Verificar si hay cambios
          if git diff --quiet && git diff --staged --quiet; then
            echo "‚úÖ No hay cambios que commitear"
          else
            echo "üìù Cambios detectados, creando commit..."
            git commit -m "ü§ñ Actualizaci√≥n autom√°tica de datos - $(date +'%Y-%m-%d %H:%M:%S')"
            
            echo "üì§ Subiendo cambios a GitHub..."
            git push
            
            echo "‚úÖ Cambios subidos exitosamente"
          fi
      
      # ===================================================================
      # FASE 6: REPORTE FINAL
      # ===================================================================
      - name: üìã Generar reporte de ejecuci√≥n
        if: always()
        run: |
          cat > execution_report.txt << 'EOF'
          ================================================================================
          ü§ñ REPORTE DE EJECUCI√ìN - PIPELINE ETL CONVIVE360
          ================================================================================
          
          üìÖ Fecha: $(date +'%Y-%m-%d %H:%M:%S')
          üîß Workflow: Actualizar Datos Power BI
          üì¶ Branch: main
          
          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          üìä ARCHIVOS GENERADOS
          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          
          EOF
          
          echo "üìÅ Dimensiones:" >> execution_report.txt
          ls -lh dimensiones/*.csv 2>/dev/null >> execution_report.txt || echo "   ‚ö†Ô∏è  No disponible" >> execution_report.txt
          
          echo "" >> execution_report.txt
          echo "üìÑ Fact Tables:" >> execution_report.txt
          ls -lh fact_*.csv 2>/dev/null >> execution_report.txt || echo "   ‚ö†Ô∏è  No disponible" >> execution_report.txt
          
          echo "" >> execution_report.txt
          echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" >> execution_report.txt
          echo "‚úÖ Pipeline ejecutado exitosamente" >> execution_report.txt
          echo "=================================================================================" >> execution_report.txt
          
          cat execution_report.txt
      
      - name: üì§ Subir reporte como artefacto
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: execution-report-${{ github.run_number }}
          path: execution_report.txt
          retention-days: 30
